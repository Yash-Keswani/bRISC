<!DOCTYPE html>
<html lang="en" style="height: 100%">

{% load static %}

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Assembler</title>
    <link rel="stylesheet" href="{% static 'RISCReward/assets/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'RISCReward/assets/css/styles.css' %}">
    <script type="text/javascript" src="{% static 'RISCReward/assets/jquery/jquery.js' %}">
    </script>
    <style>
        textarea{
            resize: none;
        }
        .editor{
            font-size: 1.5vw;
        }
        .debug{
            font-size: 2vw
        }
        .ace_gutter {
            color: #e7f1ff !important;
        }
        .editor{
            line-height: 2.2vw;
        }
    </style>
</head>

<body style="height: 100%">
<div class="hstack flex-grow-1"
     style="width: 100%;padding: 1%; height: 100%;">
    <div class="vstack" style="width: 25%;height: 100%;">
        <div class="editor" style="width: 100%;height: 92%;" id="editor_in">Code goes here</div>
        <div class="hstack d-xxl-flex" style="justify-content: space-around; margin-top: 2%; height: 8%">
            <div class="btn-group" role="group" style="width: 40%; height: 100%">
                <button class="btn btn-dark debug" type="button" onclick="submit_code_run()"
                        style="height: 100%;margin-right: 2%;width: 53%;">‚ñ∂
                </button>
                <button class="btn btn-dark debug" type="button"
                        style="height: 100%;width: 53%;">üêû
                </button>
            </div>
            <div class="btn-group" role="group"
                 style="height: 100%; width: 40%;">
                <button class="btn btn-dark debug" type="button"
                        style="height: 100%;margin-right: 2%;width: 30%; font-size: 1vw">‚Ü∑
                </button>
                <button class="btn btn-dark debug" type="button"
                        style="height: 100%;margin-right: 2%;width: 30%;">‚Ü¥
                </button>
                <button class="btn btn-dark debug" type="button"
                        style="height: 100%;width: 30%;">‚Ü±
                </button>
            </div>
        </div>
    </div>
    <div class="vstack" style="height: 100%;width: 75%;padding-left: 1%;">
        <div class="hstack" style="height: 55%;width: 100%;">
            <div style="width: 28%;height: 100%" disabled="" class="editor" id="mem">Memory Usage</div>
            <div style="width: 28%;height: 100%;margin-left: 1%" disabled="" class="editor" id="reg">Register Values</div>
            <div style="width: 28%;height: 100%;margin-left: 1%" disabled="" class="editor" id="binary">Binary Output</div>
            <div class="vstack" style="margin-left: 1%; width: 10%">
                <div class="btn-group-vertical" role="group" style="height: 100%;">
                    <button class="btn btn-dark" type="button"
                            style="height: 20%;min-height: 20%;max-height: 20%;margin: 5% 0;font-size: 1.2vw;font-family: monospace;">
                        Help
                    </button>
                    <button class="btn btn-dark" type="button"
                            style="height: 20%;min-height: 20%;max-height: 20%;margin: 5% 0;font-size: 1.2vw;font-family: monospace;">
                        ISA Specs
                    </button>
                    <button class="btn btn-dark" type="button"
                            style="height: 20%;min-height: 20%;max-height: 20%;margin: 5% 0;font-size: 1.2vw;font-family: monospace;">
                        Pipeline Diagram
                    </button>
                    <button class="btn btn-dark" type="button"
                            style="height: 20%;min-height: 20%;max-height: 20%;margin: 5% 0;font-size: 1.2vw;font-family: monospace;">
                        Access Traces
                    </button>
                </div>
            </div>
        </div>
        <div class="hstack" style="margin-top: 1%;width: 100%;height: 45%;">
            <div style="width: 57%;height: 100%; font-size: 1vw">
                <table class="table table-striped table-dark" id="state">
                    <thead>
                    <tr>
                        <th>Column 1</th>
                        <th>Column 1</th>
                        <th>Column 2</th>
                        <th>Column 3</th>
                        <th>Column 2</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>Cell 1</td>
                        <td>Cell 1</td>
                        <td>Cell 2</td>
                        <td>Cell 3</td>
                        <td>Cell 2</td>
                    </tr>
                    <tr>
                        <td>Cell 1</td>
                        <td>Cell 3</td>
                        <td>Cell 2</td>
                        <td>Cell 3</td>
                        <td>Cell 4</td>
                    </tr>
                    <tr>
                        <td>Cell 1</td>
                        <td>Cell 1</td>
                        <td>Cell 2</td>
                        <td>Cell 3</td>
                        <td>Cell 2</td>
                    </tr>
                    <tr>
                        <td>Cell 1</td>
                        <td>Cell 1</td>
                        <td>Cell 2</td>
                        <td>Cell 3</td>
                        <td>Cell 2</td>
                    </tr>
                    <tr>
                        <td>Cell 1</td>
                        <td>Cell 1</td>
                        <td>Cell 2</td>
                        <td>Cell 3</td>
                        <td>Cell 2</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="editor" style="width: 42%;height: 100%;margin-left: 1%;" id="console">Console</div>
        </div>
    </div>
</div>
<script src="{% static 'RISCReward/assets/ace/src-min/ace.js' %}"></script>
<script src="{% static 'RISCReward/assets/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
<script type="text/javascript">
    editor_IDs = ["editor_in", "binary", "mem", "reg", "console"]

    editor_IDs.forEach(ed => {
        const editor = ace.edit(ed);
        editor.setTheme("ace/theme/ambiance");
        editor.session.setMode("ace/mode/plain_text");
    })

    const editor_in = ace.edit("editor_in")
    const bin = ace.edit("binary")
    const mem = ace.edit("mem")
    const regs = ace.edit("reg")
    const consol = ace.edit("console")

    bin.renderer.setShowGutter(false)
    mem.renderer.setShowGutter(false)
    regs.renderer.setShowGutter(false)
    consol.renderer.setShowGutter(false)

    bin.setReadOnly(true)
    mem.setReadOnly(true)
    regs.setReadOnly(true)
    consol.setReadOnly(true)

    async function query (url='', data={}){
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        return response.json();
    }

    function wrap_null(text){
        if (text === undefined){
            return "_"
        } else{
            return text
        }
    }

    phases = ["F","D","X","M","W"]
    function loadTable(tableId, fields, data) {
        let rows = '<thead><tr><th scope="col">phase</th><th scope="col">Line No.</th>' +
            '<th scope="col">Opcode</th>' +
            '<th scope="col">Sources</th></tr></thead>';
        $.each(data, function(index, item) {
            let row = '<tr>';
            row += '<th scope="row">'+phases[index]+''+'</th>'
            $.each(fields, function(index, field) {
                row += '<td>' + wrap_null(item[field+'']) + '</td>';
            });
            rows += row + '</tr>';
        });
        $('#' + tableId).html(rows);
    }

    function submit_code_run(){
        query('parse_code/', {'my_code': editor_in.getValue()})
        .then(out=>{
            bin.setValue(out["bin"]);
            consol.setValue(out["out"]);
            regs.setValue(out["regs"])
            mem.setValue(out["memory"])
            bin.clearSelection()
            consol.clearSelection()
            regs.clearSelection()
            mem.clearSelection()

            console.log(out["state"]);
            console.log(JSON.parse(out["state"]));
            loadTable("state", ["lno", "opc","srcs"], JSON.parse(out["state"]))
        })
    }

</script>
</body>

</html>